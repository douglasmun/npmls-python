name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # SECURITY: Optimized matrix to reduce attack surface and CI cost
        # - Full Python version testing on Ubuntu (fastest runner)
        # - Boundary testing (3.8, 3.12) on Windows/macOS for platform compatibility
        os: [ubuntu-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
        include:
          # Windows - test oldest and newest Python only
          - os: windows-latest
            python-version: '3.8'
          - os: windows-latest
            python-version: '3.12'
          # macOS - test oldest and newest Python only
          - os: macos-latest
            python-version: '3.8'
          - os: macos-latest
            python-version: '3.12'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        # SECURITY: Include ALL dependency files in cache key to prevent stale cache
        # Prevents cache poisoning from outdated dependencies
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt', 'requirements.lock', 'setup.py', 'pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # SECURITY: Use --no-cache-dir to prevent cache poisoning
        # Remove -e (editable) flag - not needed for CI testing
        # Include platform extras for Windows-specific code coverage
        pip install --no-cache-dir .[dev,windows]

    - name: Lint with flake8
      run: |
        # SECURITY: Enforce strict linting - no --exit-zero
        # Stop the build if there are Python syntax errors or undefined names
        flake8 npmls.py --count --select=E9,F63,F7,F82 --show-source --statistics
        # PRODUCTION: Enforce all style checks (removed --exit-zero for strict mode)
        flake8 npmls.py test_npmis.py --count --max-complexity=12 --max-line-length=100 --statistics

    - name: Format check with black
      run: |
        black --check --diff npmls.py test_npmis.py

    - name: Type check with mypy
      run: |
        mypy npmls.py --ignore-missing-imports

    - name: Test with pytest
      run: |
        # SECURITY: Run tests with strict async mode and coverage enforcement
        pytest -v --asyncio-mode=strict --cov=npmls --cov-report=xml --cov-report=term-missing --cov-fail-under=80 -m "not slow"

    - name: Upload coverage reports to Codecov
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: true  # SECURITY: Fail if coverage upload fails

  integration-tests:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # SECURITY: --no-cache-dir, no -e flag
        pip install --no-cache-dir .[dev]

    - name: Run slow integration tests
      run: |
        pytest -v --asyncio-mode=strict -m "slow" --timeout=300

  security-scan:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # SECURITY: --no-cache-dir, no -e flag
        pip install --no-cache-dir .[dev,security]

    - name: Run Bandit security linter
      run: |
        # SECURITY: Fail on high severity issues
        bandit -r npmls.py -f json -o bandit-report.json -ll || true
        bandit -r npmls.py -f text -ll  # Display issues

    - name: Run Safety check
      run: |
        # SECURITY: Check for known vulnerabilities in dependencies
        safety check --json --output safety-report.json || true
        safety check  # Display issues

    - name: Run pip-audit (additional dependency scanner)
      run: |
        # SECURITY: Additional layer - checks PyPI for vulnerabilities
        pip-audit --format json --output pip-audit-report.json || true
        pip-audit  # Display issues

    - name: Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
          pip-audit-report.json

  build:
    runs-on: ubuntu-latest
    needs: [test, integration-tests, security-scan]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        # SECURITY: --no-cache-dir for build tools
        pip install --no-cache-dir build twine

    - name: Build package
      run: |
        python -m build

    - name: Check package
      run: |
        # SECURITY: Validate package before upload
        python -m twine check --strict dist/*

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: dist-packages
        path: dist/

  release:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: dist-packages
        path: dist/

    - name: Publish to Test PyPI
      if: github.ref == 'refs/heads/develop'
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.TEST_PYPI_API_TOKEN }}
        repository_url: https://test.pypi.org/legacy/

    - name: Publish to PyPI
      if: github.ref == 'refs/heads/main' && startsWith(github.ref, 'refs/tags/')
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}

  cross-platform-test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # SECURITY: Test specific OS versions for platform compatibility
        os: [ubuntu-20.04, ubuntu-22.04, windows-2019, windows-2022, macos-11, macos-12]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # SECURITY: --no-cache-dir, no -e flag
        # Include platform extras for Windows
        pip install --no-cache-dir .[windows]

    - name: Test basic functionality
      run: |
        python npmls.py --help
        python npmls.py --list-threats | head -20
      shell: bash

    - name: Test offline mode
      run: |
        python npmls.py --offline --verbose --list-threats | head -10
      shell: bash

  performance-test:
    runs-on: ubuntu-latest
    needs: test
    env:
      # SECURITY: Set fixed hash seed for reproducible benchmarks
      PYTHONHASHSEED: 12345

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # SECURITY: --no-cache-dir, no -e flag
        pip install --no-cache-dir .[dev]

    - name: Run performance benchmarks
      run: |
        python -c "
import time
import asyncio
from npmls import Scanner, ThreatDatabase

async def benchmark():
    print('=== Performance Benchmark ===')
    print(f'PYTHONHASHSEED: {\"$PYTHONHASHSEED\"}')

    # Test database loading
    start = time.time()
    db = ThreatDatabase(online_mode=False)
    threats = db.get_all_malicious_packages()
    load_time = time.time() - start
    print(f'Database load: {len(threats)} threats in {load_time:.3f}s')

    # Test scanner initialization
    start = time.time()
    scanner = Scanner(verbose=False, online_mode=False)
    await scanner.initialize()
    init_time = time.time() - start
    print(f'Scanner init: {init_time:.3f}s')

    # Test threat checking
    start = time.time()
    for _ in range(1000):
        result = db.check_package_fast('express', '4.18.2')
    check_time = time.time() - start
    print(f'1000 threat checks: {check_time:.3f}s ({1000/check_time:.0f} checks/sec)')

asyncio.run(benchmark())
        "
